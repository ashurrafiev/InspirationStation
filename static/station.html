<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Story Inspiration Station</title>
<link rel="stylesheet" href="/static/station.css">
<link rel="stylesheet" href="/static/keybonk_dark.css">
<script src="/static/words.js"></script>
<script src="/static/keybonk.js"></script>
<script src="/static/data.js"></script>
<script>

var selectedOptions = [];
var choice = null;
var data = null;

var page = 1;

var readyToSend = false;

var keybonk;
var countdown, timeout, timeoutTimer;

function switchKBTarget(e) {
	if(keybonk!==undefined)
		keybonk.switchTarget(e);
}

function updateKBSuggestions() {
	if(keybonk!==undefined)
		keybonk.updateWordSuggestions();
}

function toImgSrc(s) {
	return '/media/'+s+'.jpg';
}

function rerollOptions() {
	oldOptions = selectedOptions;
	selectedOptions = [];
	for(i=0; i<3; i++) {
		for(;;) {
			let opt = allOptions[Math.floor(Math.random() * allOptions.length)];
			if(!selectedOptions.includes(opt) && !oldOptions.includes(opt)) {
				selectedOptions.push(opt);
				document.getElementById('page1img'+i).src = toImgSrc(opt);
				break;
			}
		}
	}
}

function sanitize(s) {
    return s.replace(/&/g, "&amp;").replace(/>/g, "&gt;").replace(/</g, "&lt;").replace(/"/g, "&quot;");
}

function onPageEnter() {
	console.log('onPageEnter: page='+page);
	switch(page) {
		case 1:
			if(selectedOptions.length==0)
				rerollOptions();
            document.getElementById('q1').value = '';
            document.getElementById('q2').value = '';
            document.getElementById('q3').value = '';
            document.getElementById('p3dot2').disabled = true;
            document.getElementById('p3dot3').disabled = true;
            document.getElementById('p4dot3').disabled = true;
            document.getElementById('p3dotd').disabled = true;
            document.getElementById('p4dotd').disabled = true;
            document.getElementById('p5dotd').disabled = true;
			document.getElementById('keybonk').style.display = 'none';
			break;
		case 2:
			document.getElementById('page2img').src = toImgSrc(choice);
			document.getElementById('keybonk').style.display = 'none';
			break;
        case 3:
            document.getElementById('page3img').src = toImgSrc(choice);
			document.getElementById('q1').focus();
			document.getElementById('keybonk').style.display = 'block';
            break;
        case 4:
            document.getElementById('page4img').src = toImgSrc(choice);
            document.getElementById('p3dot2').disabled = false;
			document.getElementById('q2').focus();
			document.getElementById('keybonk').style.display = 'block';
            break;
        case 5:
            document.getElementById('page5img').src = toImgSrc(choice);
            document.getElementById('p3dot3').disabled = false;
            document.getElementById('p4dot3').disabled = false;
			document.getElementById('q3').focus();
			document.getElementById('keybonk').style.display = 'block';
            break;
		case 6:
			document.getElementById('page6img').src = toImgSrc(choice);
            document.getElementById('p3dotd').disabled = false;
            document.getElementById('p4dotd').disabled = false;
            document.getElementById('p5dotd').disabled = false;
            document.getElementById('ins1').innerHTML = sanitize(document.getElementById('q1').value.trim());
            document.getElementById('ins2').innerHTML = sanitize(document.getElementById('q2').value.trim());
            document.getElementById('ins3').innerHTML = sanitize(document.getElementById('q3').value.trim());
			document.getElementById('keybonk').style.display = 'none';
			document.getElementById('btnshare').disabled = !canPostStory();
			break;
		case 7:
			if(!readyToSend)
				locationHash = 6;
			else {
				postStory();
				readyToSend = false;
			}
			break;
		default:
			console.warn('BAD PAGE');
			document.getElementById('keybonk').style.display = 'none';
			break;
	}
}

function page1imgClick(x) {
	choice = selectedOptions[x];
    if(choice in allData)
        data = allData[choice];
    else {
        console.warn('No data for '+choice);
        data = {
            'name': 'Animal name',
            'fact': 'An interesting fact about this animal in a short sentence.'
        };
    }
    document.getElementById('p2name').innerHTML = data['name'];
    document.getElementById('p6name').innerHTML = data['name'];
    document.getElementById('p2fact').innerHTML = data['fact'];
    document.getElementById('p6fact').innerHTML = data['fact'];
	location.hash = 2;
}

function startCountdown() {
    window.onmousedown = resetTimer;  // catches touchscreen presses as well      
    window.ontouchstart = resetTimer; // catches touchscreen swipes as well      
    window.ontouchmove = resetTimer;  // required by some devices 
    window.onclick = resetTimer;      // catches touchpad clicks as well
    window.onkeydown = resetTimer;   
	
	function updateCountdown() {
		if(countdown!=null && countdown!=undefined) {
			if(timeout>0) {
				timeout = timeout - 1;
				if(timeout<=30)
					countdown.innerHTML = timeout;
				else
					countdown.innerHTML = '';
				continueTimer();
			}
			else {
				location.hash = 1;
			}
		}
	}
	function continueTimer() {
		timeoutTimer = setTimeout(updateCountdown, 1000);
	}
	function resetTimer() {
		clearTimeout(timeoutTimer);
		if(countdown!=null && countdown!=undefined) {
			timeout = 45;
			countdown.innerHTML = '';
			continueTimer();
		}
	}
	resetTimer();
}

function canPostStory() {
	return choice && data &&
		document.getElementById('q1').value.trim() &&
		document.getElementById('q2').value.trim() &&
		document.getElementById('q3').value.trim();
}

function postStory() {
	if(!readyToSend)
		return;

	document.getElementById('sending').style.display = 'block';
	document.getElementById('finish').style.display = 'none';
	document.getElementById('send-err').style.display = 'none';
	
	const xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange  = function() {
		if(this.readyState != 4)
			return;
		if(this.status == 200) {
			const resp = JSON.parse(this.responseText);
			document.getElementById('storylink').href = resp['story'];
			document.getElementById('qrcode').src = resp['qr'];
			document.getElementById('sending').style.display = 'none';
			document.getElementById('finish').style.display = 'block';
		}
		else {
			console.error(this.status);
			document.getElementById('sending').style.display = 'none';
			document.getElementById('send-err').style.display = 'block';
		}
	}
	
	const q1 = encodeURIComponent(document.getElementById('q1').value.trim());
	const q2 = encodeURIComponent(document.getElementById('q2').value.trim());
	const q3 = encodeURIComponent(document.getElementById('q3').value.trim());
	
	xhttp.open('GET', `/post?obj=${choice}&q1=${q1}&q2=${q2}&q3=${q3}`);
	xhttp.send();
}

function clickShare() {
	if(canPostStory()) {
		readyToSend = true;
		location.hash = 7;
	}
}

window.onhashchange = function() {
	document.getElementById('page'+page).style.display = 'none';
	if(location.hash.length>0)
		page = parseInt(location.hash.replace('#',''));
	else
		page = 1;
	if(page>1 && (!choice || !data)) {
		location.hash = 1;
		page = 1;
	}
	if(page<1 || page>7) page = 1;
	const pageDiv = document.getElementById('page'+page);
	pageDiv.style.display = 'block';
	onPageEnter();
	countdown = document.getElementById('countdown'+page);
	startCountdown();
}

function applyTemplate(t) {
	document.getElementById('temp-q1').innerHTML = t['q1'];
	document.getElementById('temp-q2').innerHTML = t['q2'];
	document.getElementById('temp-q3').innerHTML = t['q3'];
	let s = t['story'];
	s = s.replace('{{name}}', '<span id="p6name" class="ins"></span>');
	s = s.replace('{{fact}}', '<span id="p6fact"></span>');
	s = s.replace('{{q1}}', '<span id="ins1" class="ins"></span>');
	s = s.replace('{{q2}}', '<span id="ins2" class="ins"></span>');
	s = s.replace('{{q3}}', '<span id="ins3" class="ins"></span>');
	document.getElementById('temp-story').innerHTML = s;
}

function init() {
	keybonk = new Keybonk('keybonk');
	onhashchange()
	document.addEventListener('selectionchange', updateKBSuggestions);
	applyTemplate(storyTemplate);
}

</script>
</head>
<body onload="init()">
<h1>Story Inspiration Station</h1>
<div id="page1">
    <p>Select an object to find out more</p>
    <div><img id="page1img0" onclick="page1imgClick(0)" /><img id="page1img1" onclick="page1imgClick(1)" /><img id="page1img2" onclick="page1imgClick(2)" /></div>
    <div style="margin-top:25px"><input type="button" onclick="rerollOptions()" value="Reroll" /></div>
</div>
<div id="page2" style="display:none">
    <div class="limg"><img id="page2img" /></div>
    <div class="rbox">
        <p id="p2name" style="font-size:28px;font-weight:bold;color:#fff">Animal Name</p>
        <p id="p2fact" style="font-style:italic;margin-bottom:50px">An interesting fact about this animal in a short sentence.</p>
        <p><input type="button" onclick="location.hash=3" value="Start your story about this object" style="width:500px" /></p>
    </div>
    <div style="clear:both;padding-top:25px"><input class="back" type="button" onclick="location.hash=1" value="&#129128; Choose another" style="width:250px" />&nbsp;<label id="countdown2" class="countdown"></label></div>
</div>
<div id="page3" style="display:none">
    <div class="limg"><img id="page3img" /></div>
    <div class="rbox">
        <p style="font-size:12pt">Answer three questions to inspire a story.</p>
        <p><input id="p3dot1" class="dot now" type="button" onclick="" value="1" /><input id="p3dot2" class="dot" type="button" onclick="location.hash=4" value="2" disabled /><input id="p3dot3" class="dot" type="button" onclick="location.hash=5" value="3" disabled /><input id="p3dotd" type="button" onclick="location.hash=6" value="Done" disabled /></p>
        <p id="temp-q1" style="font-style:italic"></p>
        <textarea id="q1" onfocus="switchKBTarget(this)" oninput="updateKBSuggestions()"></textarea>
        <div style="float:right"><p><input class="back" type="button" onclick="location.hash=2" value="&#129128; Back" style="margin-right:25px"/><input type="button" onclick="location.hash=4" value="Next" /></p></div>
    </div>
    <div style="clear:both;padding-top:25px"><input class="back" type="button" onclick="location.hash=1" value="&#10006; Start over" style="width:250px" />&nbsp;<label id="countdown3" class="countdown"></label></div>
</div>
<div id="page4" style="display:none">
    <div class="limg"><img id="page4img" /></div>
    <div class="rbox">
        <p style="font-size:12pt">Answer three questions to inspire a story.</p>
        <p><input id="p4dot1" class="dot" type="button" onclick="location.hash=3" value="1" /><input id="p4dot2" class="dot now" type="button" onclick="" value="2" /><input id="p4dot3" class="dot" type="button" onclick="location.hash=5" value="3" disabled /><input id="p4dotd" type="button" onclick="location.hash=6" value="Done" disabled /></p>
        <p id="temp-q2" style="font-style:italic"></p>
        <textarea id="q2" onfocus="switchKBTarget(this)" oninput="updateKBSuggestions()"></textarea>
        <div style="float:right"><p><input class="back" type="button" onclick="location.hash=3" value="&#129128; Back" style="margin-right:25px"/><input type="button" onclick="location.hash=5" value="Next" /></p></div>
    </div>
    <div style="clear:both;padding-top:25px"><input class="back" type="button" onclick="location.hash=1" value="&#10006; Start over" style="width:250px" />&nbsp;<label id="countdown4" class="countdown"></label></div>
</div>
<div id="page5" style="display:none">
    <div class="limg"><img id="page5img" /></div>
    <div class="rbox">
        <p style="font-size:12pt">Answer three questions to inspire a story.</p>
        <p><input id="p5dot1" class="dot" type="button" onclick="location.hash=3" value="1" /><input id="p5dot2" class="dot" type="button" onclick="location.hash=4" value="2" /><input id="p5dot3" class="dot now" type="button" onclick="" value="3" /><input id="p5dotd" type="button" onclick="location.hash=6" value="Done" disabled /></p>
        <p id="temp-q3" style="font-style:italic"></p>
        <textarea id="q3" onfocus="switchKBTarget(this)" oninput="updateKBSuggestions()"></textarea>
        <div style="float:right"><p><input class="back" type="button" onclick="location.hash=4" value="&#129128; Back" style="margin-right:25px"/><input type="button" onclick="location.hash=6" value="Next" /></p></div>
    </div>
    <div style="clear:both;padding-top:25px"><input class="back" type="button" onclick="location.hash=1" value="&#10006; Start over" style="width:250px" />&nbsp;<label id="countdown5" class="countdown"></label></div>
</div>
<div id="page6" style="display:none">
    <div class="limg"><img id="page6img" /></div>
    <div class="rbox done">
        <p style="font-weight:bold;color:#000">Your story inspiration:</p>
        <div id="temp-story" class="story"></div>
        <p><input class="back" type="button" onclick="location.hash=5" value="&#129128; Change" style="width:180px;margin-right:25px"/><input id="btnshare" type="button" onclick="clickShare()" value="Share" /></p>
    </div>
    <div style="clear:both;padding-top:25px"><input class="back" type="button" onclick="location.hash=1" value="&#10006; Start over" style="width:250px" />&nbsp;<label id="countdown6" class="countdown"></label></div>
</div>
<div id="page7" style="display:none">
	<div id="sending" class="finish">
		<p>Connecting...</p>
	</div>
    <div id="finish" class="finish" style="display:none">
		<p>Your story has been sent!<br/>Use QR code below to share it with everyone.</p>
		<p><a id="storylink" href="#1"><img id="qrcode" /></a></p>
	</div>
	<div id="send-err" class="finish" style="display:none">
		<p>Oops! Something went wrong :(</p>
		<p><input class="back" type="button" onclick="location.hash=6" value="&#129128; Back" style="width:180px;margin-right:25px"/></p>
	</div>
    <div style="clear:both;padding-top:25px"><input class="back" type="button" onclick="location.hash=1" value="&#10006; Start over" style="width:250px" />&nbsp;<label id="countdown7" class="countdown"></label></div>
</div>
<div id="keybonk" class="keybonk"></div>
</body>
